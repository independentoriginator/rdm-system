<?xml version="1.1" encoding="UTF-8"?>
<databaseChangeLog 
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog-ext 
        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd 
        http://www.liquibase.org/xml/ns/dbchangelog 
        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.1.xsd">

	<changeSet id="language" author="${user}">
	
		<createTable
			tableName="language" 
			remarks="Язык">
			<column name="id" type="${type.id}" autoIncrement="true" remarks="Идентификатор">
				<constraints nullable="false" />
			</column>
			<column name="tag" type="${type.code}" remarks="Тег">
				<constraints nullable="false" />
			</column>
		</createTable>

		<addPrimaryKey 
			constraintName="pk_language" 
			tableName="language"
			columnNames="id"/>
			
		<addUniqueConstraint 
			constraintName="uc_language$tag" 
			tableName="language"
			columnNames="tag"/>

		<insert tableName="meta_type">
			<column name="internal_name" value="language"/>
		</insert>

		<insert tableName="meta_attribute">
			<column name="master_id" valueComputed="(select id from meta_type where internal_name = 'language')"/>
			<column name="internal_name" value="tag"/>
			<column name="attr_type_id" valueComputed="(select id from meta_type where internal_name = 's')"/>
			<column name="length" value="${type.length.code}"/>
			<column name="is_non_nullable" value="true"/>
			<column name="is_unique" value="true"/>			
		</insert>

		<insert tableName="meta_attribute">
			<column name="master_id" valueComputed="(select id from meta_type where internal_name = 'language')"/>
			<column name="internal_name" value="name"/>
			<column name="attr_type_id" valueComputed="(select id from meta_type where internal_name = 's')"/>
			<column name="is_non_nullable" value="true"/>
			<column name="is_localisable" value="true"/>
		</insert>

	</changeSet>

	<changeSet id="initial-languages" author="${user}">
	
		<insert tableName="language">
			<column name="tag" value="ru"/>
		</insert>

		<insert tableName="language">
			<column name="tag" value="en"/>
		</insert>

	</changeSet>

	<changeSet id="initial-languages-names" author="${user}">
	
		<preConditions onFail="CONTINUE">
			<tableExists tableName="language_lc" schemaName="${mainSchemaName}"/>
		</preConditions>	

		<insert tableName="language_lc">
			<column name="master_id" valueComputed="(select id from language where tag = 'ru')"/>
			<column name="attr_id" valueComputed="(
				select 
					a.id
				from 
					meta_type t 
				join meta_attribute a 
					on a.master_id = t.id 
				where 
					t.internal_name = 'language'
					and a.internal_name = 'name'
			)"/>
			<column name="lang_id" valueComputed="(select id from language where tag = 'ru')"/>
			<column name="lc_string" value="Русский"/>
		</insert>

		<insert tableName="language_lc">
			<column name="master_id" valueComputed="(select id from language where tag = 'ru')"/>
			<column name="attr_id" valueComputed="(
				select 
					a.id
				from 
					meta_type t 
				join meta_attribute a 
					on a.master_id = t.id 
				where 
					t.internal_name = 'language'
					and a.internal_name = 'name'
			)"/>
			<column name="lang_id" valueComputed="(select id from language where tag = 'en')"/>
			<column name="lc_string" value="Russian"/>
		</insert>

		<insert tableName="language_lc">
			<column name="master_id" valueComputed="(select id from language where tag = 'en')"/>
			<column name="attr_id" valueComputed="(
				select 
					a.id
				from 
					meta_type t 
				join meta_attribute a 
					on a.master_id = t.id 
				where 
					t.internal_name = 'language'
					and a.internal_name = 'name'
			)"/>
			<column name="lang_id" valueComputed="(select id from language where tag = 'en')"/>
			<column name="lc_string" value="English"/>
		</insert>

	</changeSet>

</databaseChangeLog>
