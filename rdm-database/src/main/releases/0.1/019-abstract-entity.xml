<?xml version="1.1" encoding="UTF-8"?>
<databaseChangeLog 
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog-ext 
        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd 
        http://www.liquibase.org/xml/ns/dbchangelog 
        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.1.xsd">

	<changeSet id="abstract-entity" author="${user}">

		<insert tableName="meta_type">
			<column name="internal_name" value="entity"/>
			<column name="is_abstract" value="true"/>
		</insert>

		<update tableName="meta_type">
			<column name="super_type_id" valueComputed="(select id from meta_type where internal_name = 'entity')"/>
			<where>id = (select id from meta_type where internal_name = 'directory')</where>
		</update>
		
		<update tableName="meta_attribute">
			<column name="master_id" valueComputed="(select id from meta_type where internal_name = 'entity')"/>
			<where>
				master_id = (select id from meta_type where internal_name = 'directory') 
				and internal_name in (
					'source_id'
					, 'external_id'
					, 'data_package_id'
					, 'source_record_date'					
				)
			</where>
		</update>

		<update tableName="meta_index">
			<column name="master_id" valueComputed="(select id from meta_type where internal_name = 'entity')"/>
			<where>
				master_id = (select id from meta_type where internal_name = 'directory') 
				and tag in (
					'data_package_id'
					, 'external_id_source_id'
				)
			</where>
		</update>
		
	</changeSet>

	<changeSet id="data_package_rn" author="${user}">
	
		<comment>Row number within data package</comment>
	
		<insert tableName="meta_attribute">
			<column name="master_id" valueComputed="(select id from meta_type where internal_name = 'entity')"/>
			<column name="internal_name" value="data_package_rn"/>
			<column name="attr_type_id" valueComputed="(select id from meta_type where internal_name = 'id')"/>
			<column name="is_non_nullable" value="true"/>
			<column name="ordinal_position" value="1"/>
		</insert>

	</changeSet>

	<changeSet id="data_package_rn-as-second-index-column" author="${user}">
	
		<update tableName="meta_index">
			<column name="tag" value="data_package_id_data_package_rn"/>
			<where>
				master_id = (select id from meta_type where internal_name = 'entity') 
				and tag = 'data_package_id'
			</where>
		</update>
	
		<update tableName="meta_index_column">
			<column name="ordinal_position" value="0"/>
			<where>
				master_id = (
					select 
						id 
					from 
						meta_index 
					where 
						master_id = (
							select 
								id 
							from 
								meta_type 
							where 
								internal_name = 'entity'
						)
						and tag = 'data_package_id_data_package_rn' 
				) 
				and meta_attr_name = 'data_package_id'
			</where>
		</update>
	
		<insert tableName="meta_index_column">
			<column name="master_id" valueComputed="(
				select 
					id 
				from 
					meta_index 
				where 
					master_id = (
						select 
							id 
						from 
							meta_type 
						where 
							internal_name = 'entity'
					)
					and tag = 'data_package_id_data_package_rn' 
			)"/>
			<column name="meta_attr_name" value="data_package_rn"/>
			<column name="ordinal_position" value="1"/>			
		</insert>
	
	</changeSet>

	<changeSet id="index-data_package_id_data_package_rn-make-unique" author="${user}">
	
		<update tableName="meta_index">
			<column name="is_unique" value="true"/>
			<where>
				master_id = (select id from meta_type where internal_name = 'entity') 
				and tag = 'data_package_id_data_package_rn'
			</where>
		</update>
	
	</changeSet>
	
	<changeSet id="data_package_rn-ordinal_position" author="${user}">

		<update tableName="meta_attribute">
			<column name="ordinal_position" value="0"/>
			<where>
				master_id = (select id from meta_type where internal_name = 'entity') 
				and internal_name = 'data_package_rn'
			</where>
		</update>

	</changeSet>
	

</databaseChangeLog>
